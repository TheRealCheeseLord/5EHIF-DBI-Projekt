<div class="page-root">
  <div class="page-wrapper">
    <header class="page-header">
      <h1>PostgreSQL â€“ Parishes</h1>
      <p>Simple CRUD playground for the Parish table.</p>
    </header>

    <div class="card">
      <div class="card-header-row">
        <h2>All Parishes</h2>
        <button class="btn" type="button" (click)="openCreate()">+ Add Parish</button>
      </div>

      <table class="table">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Location</th>
          <th>Founded</th>
        </tr>

        @for (p of parishes(); track p.id) {
        <tr>
          <td>{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.location }}</td>
          <td>{{ p.foundedYear }}</td>

          <td class="actions-cell">
            <button class="btn small" type="button" (click)="openEdit(p)">Edit</button>
            <button class="btn small danger" type="button" (click)="delete(p.id!)">Delete</button>
          </td>
        </tr>
        }
      </table>
    </div>

    <!-- FORM MODAL -->
    @if (showForm()) {
    <div class="modal">
      <div class="modal-content">
        <h2>{{ editMode() ? 'Edit parish' : 'Create parish' }}</h2>

        <form [formGroup]="form" (ngSubmit)="save()">
          <label>Name</label>
          <input type="text" formControlName="name" required />

          <label>Location</label>
          <input type="text" formControlName="location" />

          <label>Founded year</label>
          <input type="number" formControlName="foundedYear" />

          <div class="modal-actions">
            <button type="submit" class="btn">
              {{ editMode() ? 'Save' : 'Create' }}
            </button>
            <button type="button" class="btn secondary" (click)="close()">Cancel</button>
          </div>

          <!-- RELATIONS (only in edit mode) -->
          @if (editMode() && selectedParishId()) {
          <div class="relations-section">
            <h3>Relations</h3>

            <!-- PRIESTS -->
            <section class="relations-block">
              <h4>Priests</h4>

              @if (priests().length > 0) {
              <ul class="relations-list">
                @for (pr of priests(); track pr.id) {
                <li>
                  <span>{{ pr.firstName }} {{ pr.lastName }}</span>
                  <button type="button" class="btn small secondary" (click)="removePriest(pr)">
                    Remove
                  </button>
                </li>
                }
              </ul>
              } @else {
              <p class="relations-empty">No priests linked yet.</p>
              }

              <div class="inline-row">
                <input
                  type="number"
                  [value]="newPriestId() ?? ''"
                  (input)="newPriestId.set($any($event.target).valueAsNumber)"
                  placeholder="Priest ID"
                />
                <button type="button" class="btn small" (click)="addPriest()">Add priest</button>
              </div>
            </section>

            <!-- PARISHIONERS -->
            <section class="relations-block">
              <h4>Parishioners</h4>

              @if (parishioners().length > 0) {
              <ul class="relations-list">
                @for (pa of parishioners(); track pa.id) {
                <li>
                  <span>{{ pa.firstName }} {{ pa.lastName }}</span>
                  <button type="button" class="btn small secondary" (click)="removeParishioner(pa)">
                    Remove
                  </button>
                </li>
                }
              </ul>
              } @else {
              <p class="relations-empty">No parishioners linked yet.</p>
              }

              <div class="inline-row">
                <input
                  type="number"
                  [value]="newParishionerId() ?? ''"
                  (input)="newParishionerId.set($any($event.target).valueAsNumber)"
                  placeholder="Parishioner ID"
                />
                <button type="button" class="btn small" (click)="addParishioner()">
                  Add parishioner
                </button>
              </div>
            </section>
          </div>
          }
        </form>
      </div>
    </div>
    }
  </div>
</div>
