<div class="page-root">
  <div class="page-wrapper">
    <header class="page-header">
      <h1>PostgreSQL – Parishes</h1>
      <p>Simple CRUD playground for the Parish table.</p>
    </header>

    <div class="card">
      <div class="card-header-row">
        <h2>All Parishes</h2>

        <div class="card-header-actions">
          <button class="btn" type="button" (click)="openCreate()">+ New Parish</button>
        </div>
      </div>

      @if (error()) {
      <p class="error">{{ error() }}</p>
      } @if (!loading() && !error() && parishes().length === 0) {
      <p>No parishes found yet.</p>
      } @if (parishes().length > 0) {
      <table class="table">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Location</th>
          <th>Founded</th>
          <th class="actions-cell">Actions</th>
        </tr>

        @for (p of parishes(); track p.id) {
        <tr>
          <td>{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.location }}</td>
          <td>{{ p.foundedYear }}</td>

          <td class="actions-cell">
            <button class="btn small" type="button" (click)="openEdit(p)">Edit</button>
            <button class="btn small danger" type="button" (click)="delete(p)">Delete</button>
          </td>
        </tr>
        }
      </table>
      }
    </div>

    <!-- FORM MODAL -->
    @if (showForm()) {
    <div class="modal">
      <div class="modal-content">
        <div class="modal-header-row">
          <h2>{{ editMode() ? 'Edit parish' : 'Create parish' }}</h2>
          <button type="button" class="icon-btn" (click)="close()">✕</button>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()">
          <label>
            Name
            <input type="text" formControlName="name" required />
          </label>

          <label>
            Location
            <input type="text" formControlName="location" />
          </label>

          <label>
            Founded year
            <input type="number" formControlName="foundedYear" />
          </label>

          <div class="modal-actions">
            <button type="submit" class="btn">
              {{ editMode() ? 'Save' : 'Create' }}
            </button>
            <button type="button" class="btn secondary" (click)="close()">Cancel</button>
          </div>

          <!-- RELATIONS -->
          @if (editMode() && form.value.id) {
          <div class="relations-section">
            <div class="relations-header">
              <h3>Relations</h3>
              @if (relationsLoading()) {
              <span class="relations-loading">Loading relations…</span>
              }
            </div>

            <!-- PRIESTS -->
            <section class="relations-block">
              <h4>Priests</h4>

              @if (priests().length > 0) {
              <ul class="relations-list">
                @for (pr of priests(); track pr.id) {
                <li>
                  <span>{{ pr.firstName }} {{ pr.lastName }}</span>
                  <button type="button" class="btn small secondary" (click)="removePriest(pr)">
                    Remove
                  </button>
                </li>
                }
              </ul>
              } @else {
              <p class="relations-empty">No priests linked yet.</p>
              }

              <div class="inline-row">
                <input
                  type="number"
                  [value]="newPriestId()!"
                  (input)="newPriestId.set($any($event.target).valueAsNumber)"
                  placeholder="Priest ID"
                />
                <button type="button" class="btn small" (click)="addPriest()">Add priest</button>
              </div>
            </section>

            <!-- PARISHIONERS -->
            <section class="relations-block">
              <h4>Parishioners</h4>

              @if (parishioners().length > 0) {
              <ul class="relations-list">
                @for (pa of parishioners(); track pa.id) {
                <li>
                  <span>{{ pa.firstName }} {{ pa.lastName }}</span>
                  <button type="button" class="btn small secondary" (click)="removeParishioner(pa)">
                    Remove
                  </button>
                </li>
                }
              </ul>
              } @else {
              <p class="relations-empty">No parishioners linked yet.</p>
              }

              <div class="inline-row">
                <input
                  type="number"
                  [value]="newParishionerId()!"
                  (input)="newParishionerId.set($any($event.target).valueAsNumber)"
                  placeholder="Parishioner ID"
                />
                <button type="button" class="btn small" (click)="addParishioner()">
                  Add parishioner
                </button>
              </div>
            </section>
          </div>
          }
        </form>
      </div>
    </div>
    }
  </div>
</div>
