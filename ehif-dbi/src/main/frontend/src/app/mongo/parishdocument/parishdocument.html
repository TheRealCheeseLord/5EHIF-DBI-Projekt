<div class="page-root">
  <div class="page-wrapper">
    <header class="page-header">
      <h1>MongoDB – Parish Documents</h1>
      <p>CRUD playground for Parish Documents with Embedded Lists.</p>
    </header>

    <div class="card">
      <div class="card-header-row">
        <h2>All Documents</h2>

        <div class="card-header-actions">
          <button class="btn" type="button" (click)="openCreateDoc()">+ New Document</button>
        </div>
      </div>

      @if (error()) {
      <p class="error">{{ error() }}</p>
      } @if (!loading() && documents().length === 0) {
      <p>No documents found.</p>
      } @if (documents().length > 0) {
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Location</th>
            <th>Founded</th>
            <th class="actions-cell">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (d of documents(); track d.id) {
          <tr>
            <td class="text-small">{{ d.id }}</td>
            <td>{{ d.name }}</td>
            <td>{{ d.location }}</td>
            <td>{{ d.foundedYear }}</td>
            <td class="actions-cell">
              <button class="btn small" type="button" (click)="openEditDoc(d)">Edit</button>
              <button class="btn small danger" type="button" (click)="deleteDoc(d)">Delete</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
      }
    </div>

    @if (showDocModal()) {
    <div class="modal backdrop-blur">
      <div class="modal-content">
        <div class="modal-header-row">
          <h2>{{ editDocMode() ? 'Edit Document' : 'Create Document' }}</h2>
          <button type="button" class="icon-btn" (click)="closeDocModal()">✕</button>
        </div>

        <form [formGroup]="docForm" (ngSubmit)="saveDoc()">
          <label>
            Name
            <input type="text" formControlName="name" />
          </label>

          <label>
            Location
            <input type="text" formControlName="location" />
          </label>

          <label>
            Founded Year
            <input type="number" formControlName="foundedYear" />
          </label>

          <div class="modal-actions">
            <button type="submit" class="btn" [disabled]="docForm.invalid">
              {{ editDocMode() ? 'Save' : 'Create' }}
            </button>
            <button type="button" class="btn secondary" (click)="closeDocModal()">Cancel</button>
          </div>
        </form>

        @if (editDocMode() && currentDoc(); as doc) {
        <div class="relations-section">
          <div class="relations-header">
            <h3>Embedded Data</h3>
          </div>

          <section class="relations-block">
            <div class="block-header">
              <h4>Priests</h4>
              <button class="btn small" type="button" (click)="openAddEmbedded('priest')">
                + Add Priest
              </button>
            </div>

            @if (doc.priests?.length) {
            <ul class="relations-list">
              @for (pr of doc.priests; track pr.id) {
              <li>
                <div class="info-col">
                  <span class="fw-bold">{{ pr.firstName }} {{ pr.lastName }}</span>
                  <span class="text-muted">Ord: {{ pr.ordinationDate }}</span>
                </div>
                <div class="actions-col">
                  <button
                    type="button"
                    class="btn small secondary"
                    (click)="openEditEmbedded('priest', pr)"
                  >
                    Edit
                  </button>
                  <button
                    type="button"
                    class="btn small danger"
                    (click)="removeEmbedded('priest', pr.id!)"
                  >
                    Remove
                  </button>
                </div>
              </li>
              }
            </ul>
            } @else {
            <p class="relations-empty">No priests embedded.</p>
            }
          </section>

          <section class="relations-block">
            <div class="block-header">
              <h4>Parishioners</h4>
              <button class="btn small" type="button" (click)="openAddEmbedded('parishioner')">
                + Add Parishioner
              </button>
            </div>

            @if (doc.parishioners?.length) {
            <ul class="relations-list">
              @for (pa of doc.parishioners; track pa.id) {
              <li>
                <div class="info-col">
                  <span class="fw-bold">{{ pa.firstName }} {{ pa.lastName }}</span>
                  <span class="text-muted">Born: {{ pa.birthDate }}</span>
                </div>
                <div class="actions-col">
                  <button
                    type="button"
                    class="btn small secondary"
                    (click)="openEditEmbedded('parishioner', pa)"
                  >
                    Edit
                  </button>
                  <button
                    type="button"
                    class="btn small danger"
                    (click)="removeEmbedded('parishioner', pa.id!)"
                  >
                    Remove
                  </button>
                </div>
              </li>
              }
            </ul>
            } @else {
            <p class="relations-empty">No parishioners embedded.</p>
            }
          </section>
        </div>
        }
      </div>
    </div>
    } @if (showEmbeddedModal()) {
    <div class="modal modal-overlay">
      <div class="modal-content small-modal">
        <div class="modal-header-row">
          <h2>{{ embeddedEditMode() ? 'Edit' : 'Add' }} {{ embeddedType() | titlecase }}</h2>
          <button type="button" class="icon-btn" (click)="closeEmbeddedModal()">✕</button>
        </div>

        <form [formGroup]="embeddedForm" (ngSubmit)="saveEmbedded()">
          <label>
            First Name
            <input type="text" formControlName="firstName" />
          </label>

          <label>
            Last Name
            <input type="text" formControlName="lastName" />
          </label>

          <label>
            {{ embeddedType() === 'priest' ? 'Ordination Date' : 'Birth Date' }}
            <input type="date" formControlName="dateField" />
          </label>

          <div class="modal-actions">
            <button type="submit" class="btn" [disabled]="embeddedForm.invalid">
              {{ embeddedEditMode() ? 'Save' : 'Add' }}
            </button>
            <button type="button" class="btn secondary" (click)="closeEmbeddedModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
    }
  </div>
</div>
